<html>
  <head>
    <title>Pollwiser</title>
    <link type="text/css" rel="stylesheet" href="rickshaw.min.css" />
    <link rel="stylesheet" type="text/css" href="main.css" />
    
    <script type='text/javascript' src='https://static.firebase.com/v0/firebase.js'></script>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>
	<script src='vendor/d3.min.js'></script>
	<script src='vendor/d3.layout.min.js'></script>
	<script src='rickshaw.min.js'></script>
  </head>
 <body>

   <!-- Begin Wrapper -->
   <div id="wrapper">
   
         <!-- Begin Header -->
         <div id="header">
         	<h1>Pollwiser</h1> 
		 </div>
		 <!-- End Header -->
		 
		 <!-- Begin Content -->
		 <div id="content">
		       
		  	<div id='poll_data'>&nbsp;</div>
		
			<div id="chart_container">
			        <div id="y_axis">&nbsp;</div>
			        <div id="chart">&nbsp;</div>
			        <div id="legend">&nbsp;</div>
		            <div id="timeline">&nbsp;</div>
			</div>
		 </div>
		 <!-- End Content -->
		 <div id='sub_content'>
			<div id='poll_agency_cloud'>
				<iframe id='cloud_frame' src="poll_cloud.html">
				</iframe>
			</div> 
		 </div>
		 
		 <!-- Begin Footer -->
		 <div id="footer">
			<ul id="navlist">
				<li><a href="#" id="current">Home</a></li>
				<li><a href="#">Contact</a></li>
				<li><a href="#">About</a></li>
				<li><a href="#">News</a></li>
			</ul> 
	     </div>
		 <!-- End Footer -->
   </div>
   <!-- End Wrapper -->
   
 	<script type='text/javascript'>
		var pollDataRef = new Firebase('https://demo.firebase.com/seifeet/rcp');
		var twitDataRef = new Firebase('https://demo.firebase.com/seifeet/twitter_data_2');
	    window.series       = [];
		window.chartDataDem = [];
		window.chartDataGOP = [];
		window.chartDates   = {};
        window.chartTweets  = {};
		window.polls        = {};
				
		pollDataRef.on('child_added', function(snapshot) {
			var data = snapshot.val();
			//$("#poll_data").html(data.Date + '&nbsp;' + $("#poll_data").html());
			if( window.polls[data.Poll] === undefined ) {
				window.polls[data.Poll] = 0;
			} else {
				window.polls[data.Poll] = window.polls[data.Poll] + 1;
			}
			if( window.chartDates[data.Date] === undefined ) {
				window.chartDataDem.push({x:parseInt(data.Date), y:parseFloat(data.Obama)});
				window.chartDataGOP.push({x:parseInt(data.Date), y:parseFloat(data.Romney)});
				window.chartDates[data.Date] = data.Date;
			}
		});

        twitDataRef.on('child_added', function(snapshot) {
            var data = snapshot.val();

            if( window.chartTweets[data.date] === undefined ) {
                window.chartTweets[data.date] = data;
            }
        });
		
		function updateSeries() {
			window.chartDataDem.sort(function(a,b){return a.x - b.x});
			series.push({ name: 'Obama', color: 'steelblue', data: window.chartDataDem });
			
			window.chartDataGOP.sort(function(a,b){return a.x - b.x});
			series.push({ name: 'Romney', color: 'red', data: window.chartDataGOP });
		}

		function initChart() {
			window.graph = new Rickshaw.Graph( {
		        element: document.querySelector("#chart"),
		        renderer: 'line',
		        width: 600,
		        height: 500,
		        series: window.series
			} );
			
			var axes = new Rickshaw.Graph.Axis.Time( { graph: window.graph } );
			var y_ticks = new Rickshaw.Graph.Axis.Y( {
				element: document.querySelector("#y_axis"),
				graph: window.graph,
				orientation: 'left',
				tickFormat: Rickshaw.Fixtures.Number.formatKMBT
			} );
			
			var legend = new Rickshaw.Graph.Legend( {
			        element: document.querySelector('#legend'),
			        graph: window.graph
			} );

            var hoverDetail = new Rickshaw.Graph.HoverDetail( {
                graph: window.graph,
                formatter: function(series, x, y) {
                    var date = '<span class="date">' + new Date(x * 1000).toUTCString() + '</span>';
                    var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
                    var content = swatch + series.name + ": " + parseInt(y) + '<br>' + date;

                    if (x === undefined) {
                        content +=  '<br>' + 'No Tweets for Today. Blame Twitter\'s 7 day max API';
                        return content;
                    }
                    if (window.chartTweets[x] === undefined){
                        content +=  '<br>' + 'No Tweets for Today. Blame Twitter\'s 7 day max API';
                        return content;
                    }
                    if (window.chartTweets[x]['obama_popular_tweets'] === undefined) {
                        content +=  '<br>' + 'No Tweets for Today. Blame Twitter\'s 7 day max API';
                        return content;
                    }
                    content +=  '<br><br>@' + window.chartTweets[x]['obama_popular_tweets'][0]['from_user'] + ': <br>' + window.chartTweets[x]['obama_popular_tweets'][0]['text'];
                    content +=  '<br><br>@' + window.chartTweets[x]['obama_popular_tweets'][1]['from_user'] + ': <br>' + window.chartTweets[x]['obama_popular_tweets'][1]['text'];
                    content +=  '<br><br>' + 'Obama mentions retweeted: ' + window.chartTweets[x]['obama_count'];
                    content +=  '<br>' + 'Romney mentions retweeted: ' + window.chartTweets[x]['romney_count'];
                    return content;
                }
            } );

            var annotator = new Rickshaw.Graph.Annotate( {
                graph: window.graph,
                element: document.querySelector('#timeline')
            } );

            var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight( {
                graph: window.graph,
                legend: legend
            } );

            var ticksTreatment = 'glow';
            
            window.graph.render();
		}

		function printChart() {
			window.graph.update();
		}

		setTimeout("updateSeries(); initChart(); printChart();", 2000);
		setInterval("updateSeries(); printChart();", 5000);
	</script>

</body>
</html>

